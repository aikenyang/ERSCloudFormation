{
    "AWSTemplateFormatVersion":"2010-09-09",
    "Description":"opsworks stack",
    "Conditions":{
        "IsModeProd":{
            "Fn::Equals":[
                {
                    "Ref":"EnvironmentType"
                },
                "prod"
            ]
        },
        "IsModeStag":{
            "Fn::Equals":[
                {
                    "Ref":"EnvironmentType"
                },
                "stag"
            ]
        },
        "IsModeTest":{
            "Fn::Equals":[
                {
                    "Ref":"EnvironmentType"
                },
                "test"
            ]
        },
        "IsModeLoad":{
            "Fn::Equals":[
                {
                    "Ref":"EnvironmentType"
                },
                "load"
            ]
        },
        "IsAddingNewrelicJava":{
            "Fn::Or":[
                {
                    "Condition":"IsModeProd"
                },
                {
                    "Condition":"IsModeLoad"
                }
            ]
        }
    },
    "Parameters":{
        "Prefix":{
            "Description":"prefix of resources",
            "Type":"String",
            "MinLength":"1",
            "MaxLength":"24",
            "ConstraintDescription":"Length is too long"
        },
        "PackageURL":{
            "Default":"https://s3.amazonaws.com/coretech-ers/packages/app/arq/arq-3.0.48.el6.x86_64.rpm",
            "Description":"package path",
            "Type":"String"
        },
        "EC2InstanceClass":{
            "Default":"m3.large",
            "Description":"EC2 instance class",
            "Type":"String",
            "AllowedValues":[
                "m1.small",
                "m3.medium",
                "m3.large",
                "m3.xlarge",
                "m3.2xlarge",
                "c1.medium",
                "c1.xlarge"
            ],
            "ConstraintDescription":"EC2InstanceClass must select a valid EC2 instance type."
        },
        "KeyPair":{
            "Description":"EC2 ssh keypare name",
            "Type":"String",
            "MinLength":"1",
            "MaxLength":"64",
            "ConstraintDescription":"Length is too long"
        },
        "VPC":{
            "Description":"VPC id",
            "Type":"String"
        },
        "SubnetPublic1":{
            "Type":"String"
        },
        "SubnetPublic2":{
            "Type":"String"
        },
        "SubnetPrivateApp1":{
            "Type":"String"
        },
        "SubnetPrivateApp2":{
            "Type":"String"
        },
        "SecurityGroupARQGroupId":{
            "Type":"String"
        },
        "EnvironmentType":{
            "Description":"EnvironmentType: prod, qa. Default is qa",
            "Type":"String"
        },
        "OpsworksAccessKey":{
            "Description":"AWS Access Key",
            "Type":"String"
        },
        "OpsworksSecretKey":{
            "Description":"AWS Secret Key",
            "NoEcho":"true",
            "Type":"String"
        },
        "OpsWorksServiceRoleArn":{
            "Type":"String"
        },
        "DefaultInstanceProfileArn":{
            "Type":"String"
        }
    },
    "Resources":{
        "OpsWorksStackARQ":{
            "Type":"AWS::OpsWorks::Stack",
            "Properties":{
                "Name":{
                    "Fn::Join":[
                        ".",
                        [
                            {
                                "Ref":"Prefix"
                            },
                            "arq"
                        ]
                    ]
                },
                "ServiceRoleArn":{
                    "Ref":"OpsWorksServiceRoleArn"
                },
                "DefaultOs":"Custom",
                "DefaultRootDeviceType":"ebs",
                "DefaultSshKeyName":{
                    "Ref":"KeyPair"
                },
                "ChefConfiguration":{
                    "BerkshelfVersion":"3.2.0",
                    "ManageBerkshelf":"true"
                },
                "ConfigurationManager":{
                    "Name":"Chef",
                    "Version":"11.10"
                },
                "CustomCookbooksSource":{
                    "Type":"s3",
                    "Url":"https://s3.amazonaws.com/coretech-ers/cloudformation/opsworks/arq/chef.zip"
                },
                "DefaultInstanceProfileArn":{
                    "Ref":"DefaultInstanceProfileArn"
                },
                "VpcId":{
                    "Ref":"VPC"
                },
                "DefaultSubnetId":{
                    "Ref":"SubnetPublic1"
                },
                "UseCustomCookbooks":true,
                "UseOpsworksSecurityGroups":false
            }
        },
        "OpsWorksAppARQ":{
            "Type":"AWS::OpsWorks::App",
            "DependsOn":[
                "OpsWorksStackARQ"
            ],
            "Properties":{
                "StackId":{
                    "Ref":"OpsWorksStackARQ"
                },
                "Name":"arq",
                "Shortname":"arq",
                "Type":"other",
                "AppSource":{
                    "Type":"s3",
                    "Url":{
                        "Ref":"PackageURL"
                    },
                    "Username":{
                        "Ref":"OpsworksAccessKey"
                    },
                    "Password":{
                        "Ref":"OpsworksSecretKey"
                    }
                },
                "DataSources":{
                    "Ref":"AWS::NoValue"
                }
            }
        },
        "OpsWorksLayerARQ":{
            "Type":"AWS::OpsWorks::Layer",
            "DependsOn":[
                "OpsWorksAppARQ"
            ],
            "Properties":{
                "StackId":{
                    "Ref":"OpsWorksStackARQ"
                },
                "Name":"ARQ",
                "Type":"custom",
                "CustomRecipes":{
                    "Setup":[
                        "cookbook-arq::setup"
                    ],
                    "Deploy":[
                        "cookbook-arq::deploy"
                    ],
                    "Undeploy":[
                        "cookbook-arq::undeploy"
                    ]
                },
                "Shortname":"arq",
                "EnableAutoHealing":"true",
                "AutoAssignElasticIps":"true",
                "AutoAssignPublicIps":"false",
                "CustomSecurityGroupIds":[
                    {
                        "Ref":"SecurityGroupARQGroupId"
                    }
                ]
            }
        },
        "OpsWorksInstanceARQ":{
            "Type":"AWS::OpsWorks::Instance",
            "Properties":{
                "StackId":{
                    "Ref":"OpsWorksStackARQ"
                },
                "LayerIds":[
                    {
                        "Ref":"OpsWorksLayerARQ"
                    }
                ],
                "InstanceType":{
                    "Ref":"EC2InstanceClass"
                },
                "AvailabilityZone":{
                    "Fn::Select":[
                        "0",
                        {
                            "Fn::GetAZs":""
                        }
                    ]
                },
                "SubnetId":{
                    "Ref":"SubnetPublic1"
                }
            }
        }
    },
    "Outputs":{
        "OpsWorksStackARQ":{
            "Value":{
                "Ref":"OpsWorksStackARQ"
            }
        }
    }
}
