{
    "AWSTemplateFormatVersion":"2010-09-09",
    "Description":"opsworks stack",
    "Conditions":{
        "IsModeProd":{
            "Fn::Equals":[
                {
                    "Ref":"EnvironmentType"
                },
                "prod"
            ]
        },
        "IsModeStag":{
            "Fn::Equals":[
                {
                    "Ref":"EnvironmentType"
                },
                "stag"
            ]
        },
        "IsModeTest":{
            "Fn::Equals":[
                {
                    "Ref":"EnvironmentType"
                },
                "test"
            ]
        },
        "IsModeLoad":{
            "Fn::Equals":[
                {
                    "Ref":"EnvironmentType"
                },
                "load"
            ]
        }
    },
    "Parameters":{
        "Prefix":{
            "Description":"prefix of resources",
            "Type":"String",
            "MinLength":"1",
            "MaxLength":"24",
            "ConstraintDescription":"Length is too long"
        },
        "KeyPair":{
            "Description":"EC2 ssh keypare name",
            "Type":"String",
            "MinLength":"1",
            "MaxLength":"64",
            "ConstraintDescription":"Length is too long"
        },
        "VPC":{
            "Description":"VPC id",
            "Type":"String"
        },
        "SubnetPublic1":{
            "Type":"String"
        },
        "SubnetPublic2":{
            "Type":"String"
        },
        "SubnetPrivateApp1":{
            "Type":"String"
        },
        "SubnetPrivateApp2":{
            "Type":"String"
        },
        "SecurityGroupAMPSELBGroupId":{
            "Type":"String"
        },
        "SecurityGroupAMPSGroupId":{
            "Type":"String"
        },
        "EnvironmentType":{
            "Description":"EnvironmentType: prod, stag, test, load",
            "Type":"String"
        },
        "OpsworksAccessKey":{
            "Description":"AWS Access Key",
            "Type":"String"
        },
        "OpsworksSecretKey":{
            "Description":"AWS Secret Key",
            "NoEcho":"true",
            "Type":"String"
        },
        "OpsWorksServiceRoleArn":{
            "Type":"String"
        },
        "OpsWorksInstanceProfileArn":{
            "Type":"String"
        },
        "EC2InstanceClass":{
            "Default":"m3.medium",
            "Description":"EC2 instance class",
            "Type":"String",
            "AllowedValues":[
                "m1.small",
                "m3.medium",
                "m3.large",
                "m3.xlarge",
                "m3.2xlarge",
                "c1.medium",
                "c1.xlarge"
            ],
            "ConstraintDescription":"EC2InstanceClass must select a valid EC2 instance type."
        },
        "PackageURL":{
            "Default":"https://s3.amazonaws.com/coretech-ers/packages/app/amps/smap-1.0.dev_build-Linux-1.0-dev_build-x86_64.rpm",
            "Description":"package path",
            "Type":"String"
        }
    },
    "Resources":{
        "OpsWorksStackSMAP":{
            "Type":"AWS::OpsWorks::Stack",
            "Properties":{
                "Name":{
                    "Fn::Join":[
                        ".",
                        [
                            {
                                "Ref":"Prefix"
                            },
                            "amps"
                        ]
                    ]
                },
                "ServiceRoleArn":{
                    "Ref":"OpsWorksServiceRoleArn"
                },
                "DefaultOs":"Amazon Linux 2015.09",
                "DefaultRootDeviceType":"ebs",
                "DefaultSshKeyName":{
                    "Ref":"KeyPair"
                },
                "DefaultInstanceProfileArn":{
                    "Ref":"OpsWorksInstanceProfileArn"
                },
                "VpcId":{
                    "Ref":"VPC"
                },
                "DefaultSubnetId":{
                    "Ref":"SubnetPrivateApp1"
                },
                "UseOpsworksSecurityGroups":false,
                "ConfigurationManager":{
                    "Name":"Chef",
                    "Version":"11.10"
                },
                "CustomCookbooksSource":{
                    "Type":"s3",
                    "Url":"https://s3.amazonaws.com/coretech-ers/cloudformation/opsworks/amps/chef.zip"
                },
                "UseCustomCookbooks":true
            }
        },
        "OpsWorksLayerSMAP":{
            "Type":"AWS::OpsWorks::Layer",
            "Properties":{
                "StackId":{
                    "Ref":"OpsWorksStackSMAP"
                },
                "Name":"SMAP",
                "Type":"custom",
                "CustomRecipes":{
                    "Setup":[
                        "cookbook-smap::setup"
                    ],
                    "Deploy":[
                        "cookbook-smap::deploy"
                    ],
                    "Undeploy":[
                        "cookbook-smap::undeploy"
                    ]
                },
                "Shortname":{
                    "Fn::Join":[
                        ".",
                        [
                            {
                                "Ref":"Prefix"
                            },
                            "smap"
                        ]
                    ]
                },
                "EnableAutoHealing":"true",
                "AutoAssignElasticIps":"false",
                "AutoAssignPublicIps":"false",
                "CustomSecurityGroupIds":[
                    {
                        "Ref":"SecurityGroupAMPSGroupId"
                    }
                ]
            }
        },
        "OpsWorksInstanceSMAP":{
            "Type":"AWS::OpsWorks::Instance",
            "Properties":{
                "StackId":{
                    "Ref":"OpsWorksStackSMAP"
                },
                "LayerIds":[
                    {
                        "Ref":"OpsWorksLayerSMAP"
                    }
                ],
                "InstanceType":{
                    "Ref":"EC2InstanceClass"
                },
                "AvailabilityZone":{
                    "Fn::Select":[
                        "0",
                        {
                            "Fn::GetAZs":""
                        }
                    ]
                },
                "SubnetId":{
                    "Ref":"SubnetPrivateApp1"
                }
            }
        },
        "OpsWorksAppSMAP":{
            "Type":"AWS::OpsWorks::App",
            "Properties":{
                "StackId":{
                    "Ref":"OpsWorksStackSMAP"
                },
                "Name":"smap",
                "Shortname":"smap",
                "Type":"other",
                "AppSource":{
                    "Type":"s3",
                    "Url":{
                        "Ref":"PackageURL"
                    },
                    "Username":{
                        "Ref":"OpsworksAccessKey"
                    },
                    "Password":{
                        "Ref":"OpsworksSecretKey"
                    }
                },
                "DataSources":{
                    "Ref":"AWS::NoValue"
                }
            }
        },
        "ElbAMPS":{
            "Type":"AWS::ElasticLoadBalancing::LoadBalancer",
            "Properties":{
                "CrossZone":"true",
                "SecurityGroups":[
                    {
                        "Ref":"SecurityGroupAMPSELBGroupId"
                    }
                ],
                "Subnets":[
                    {
                        "Ref":"SubnetPublic1"
                    },
                    {
                        "Ref":"SubnetPublic2"
                    }
                ],
                "Listeners":[
                    {
                        "InstanceProtocol":"tcp",
                        "LoadBalancerPort":"25",
                        "InstancePort":"25",
                        "Protocol":"tcp"
                    }
                ],
                "HealthCheck":{
                    "Target":"TCP:25",
                    "HealthyThreshold":"3",
                    "UnhealthyThreshold":"5",
                    "Interval":"6",
                    "Timeout":"5"
                },
                "Policies":[
                    {
                        "InstancePorts":[
                            "25"
                        ],
                        "PolicyName":"EnableSMTPProxyProtocolPolicy",
                        "PolicyType":"ProxyProtocolPolicyType",
                        "Attributes":[
                            {
                                "Name":"ProxyProtocol",
                                "Value":true
                            }
                        ]
                    }
                ]
            }
        },
        "ElbAttachmentAMPS":{
            "Type":"AWS::OpsWorks::ElasticLoadBalancerAttachment",
            "Properties":{
                "ElasticLoadBalancerName":{
                    "Ref":"ElbAMPS"
                },
                "LayerId":{
                    "Ref":"OpsWorksLayerSMAP"
                }
            }
        }
    },
    "Outputs":{
        "OpsWorksStackSMAP":{
            "Value":{
                "Ref":"OpsWorksStackSMAP"
            }
        },
        "ElbAMPSDNSName":{
            "Value":{
                "Fn::GetAtt":[
                    "ElbAMPS",
                    "DNSName"
                ]
            }
        }
    }
}