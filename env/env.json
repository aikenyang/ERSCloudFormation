{
    "AWSTemplateFormatVersion":"2010-09-09",
    "Description":"ERS Infrastructure",
    "Parameters":{
        "Prefix":{
            "Default":"ers-test",
            "Description":"Name of the environment. prefix of all resources",
            "Type":"String",
            "MinLength":"1",
            "MaxLength":"24",
            "ConstraintDescription":"Length is too long"
        },
        "KeyPair":{
            "Description":"EC2 ssh keypare name",
            "Default":"ThomasPOC-Viginia",
            "Type":"String",
            "MinLength":"1",
            "MaxLength":"64",
            "ConstraintDescription":"Length is too long"
        },
        "AdminCidr":{
            "Description":"source IP of the admin user to access bastion. Like the office IP address.",
            "Default":"0.0.0.0/0",
            "Type":"String",
            "MinLength":"1",
            "MaxLength":"32",
            "ConstraintDescription":"Length is too long"
        },
        "CIDRPrefix":{
            "Default":"10.10",
            "Description":"network cidr prefix",
            "Type":"String",
            "MinLength":"1",
            "MaxLength":"8",
            "ConstraintDescription":"Length is too long"
        },
        "NatBastionAmiId":{
            "Default":"ami-3c1d4956",
            "Description":"AMI image id for NAT / Bastion",
            "Type":"String",
            "MinLength":"1",
            "MaxLength":"24"
        },
        "NatInstanceClass":{
            "Default":"t2.micro",
            "Description":"NAT EC2 instance class",
            "Type":"String",
            "AllowedValues":[
                "t2.micro",
                "t2.medium",
                "m3.medium",
                "c4.xlarge"
            ],
            "ConstraintDescription":"Please check AllowedValues if constraint happens"
        },
        "EnvironmentType":{
            "Description":"EnvironmentType: prod, stag, test, load. Default is test",
            "Default":"test",
            "Type":"String",
            "AllowedValues":[
                "prod",
                "stag",
                "test",
                "load"
            ]
        },
        "OpsworksAccessKey":{
            "Description":"AWS Access Key",
            "Type":"String"
        },
        "OpsworksSecretKey":{
            "Description":"AWS Secret Key",
            "NoEcho":"true",
            "Type":"String"
        }
    },
    "Resources":{
        "VPCStack":{
            "Type":"AWS::CloudFormation::Stack",
            "Properties":{
                "TemplateURL":"https://s3-us-west-2.amazonaws.com/mongodb-cloudformation/module-vpc.json",
                "Parameters":{
                    "Prefix":{
                        "Ref":"Prefix"
                    },
                    "AdminCidr":{
                        "Ref":"AdminCidr"
                    },
                    "CIDRPrefix":{
                        "Ref":"CIDRPrefix"
                    }
                }
            }
        },
        "SGStack":{
            "Type":"AWS::CloudFormation::Stack",
            "DependsOn":[
                "VPCStack"
            ],
            "Properties":{
                "TemplateURL":"https://s3-us-west-2.amazonaws.com/mongodb-cloudformation/module-securitygroup.json",
                "Parameters":{
                    "Prefix":{
                        "Ref":"Prefix"
                    },
                    "AdminCidr":{
                        "Ref":"AdminCidr"
                    },
                    "CIDRPrefix":{
                        "Ref":"CIDRPrefix"
                    },
                    "VPC":{
                        "Fn::GetAtt":[
                            "VPCStack",
                            "Outputs.VPC"
                        ]
                    },
                    "EnvironmentType":{
                        "Ref":"EnvironmentType"
                    }
                }
            }
        },
        "NatBastionStack":{
            "Type":"AWS::CloudFormation::Stack",
            "DependsOn":[
                "VPCStack",
                "SGStack"
            ],
            "Properties":{
                "TemplateURL":"https://s3-us-west-2.amazonaws.com/mongodb-cloudformation/module-natbastion.json",
                "Parameters":{
                    "Prefix":{
                        "Ref":"Prefix"
                    },
                    "SecurityGroupNat":{
                        "Fn::GetAtt":[
                            "SGStack",
                            "Outputs.SecurityGroupNat"
                        ]
                    },
                    "SecurityGroupBastion":{
                        "Fn::GetAtt":[
                            "SGStack",
                            "Outputs.SecurityGroupBastion"
                        ]
                    },
                    "AdminCidr":{
                        "Ref":"AdminCidr"
                    },
                    "CIDRPrefix":{
                        "Ref":"CIDRPrefix"
                    },
                    "NatBastionAmiId":{
                        "Ref":"NatBastionAmiId"
                    },
                    "NatInstanceClass":{
                        "Ref":"NatInstanceClass"
                    },
                    "KeyPair":{
                        "Ref":"KeyPair"
                    },
                    "VPC":{
                        "Fn::GetAtt":[
                            "VPCStack",
                            "Outputs.VPC"
                        ]
                    },
                    "SubnetPublic1":{
                        "Fn::GetAtt":[
                            "VPCStack",
                            "Outputs.SubnetPublic1"
                        ]
                    },
                    "SubnetPublic2":{
                        "Fn::GetAtt":[
                            "VPCStack",
                            "Outputs.SubnetPublic2"
                        ]
                    },
                    "RouteTableNat1":{
                        "Fn::GetAtt":[
                            "VPCStack",
                            "Outputs.RouteTableNat1"
                        ]
                    },
                    "RouteTableNat2":{
                        "Fn::GetAtt":[
                            "VPCStack",
                            "Outputs.RouteTableNat2"
                        ]
                    }
                }
            }
        },
        "OpsStack":{
            "Type":"AWS::CloudFormation::Stack",
            "DependsOn":[
                "VPCStack",
                "SGStack"
            ],
            "Properties":{
                "TemplateURL":"https://s3-us-west-2.amazonaws.com/mongodb-cloudformation/module-ops.json"
            }
        }
    }
}